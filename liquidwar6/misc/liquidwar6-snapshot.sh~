#!/bin/sh

. /etc/profile > /dev/null 2>&1

LW6_BIN="/var/opt/snapshots/liquidwar6/bin"
LW6_LOG="/var/opt/snapshots/liquidwar6/log"
LW6_PUB="/var/opt/snapshots/liquidwar6/pub"
LW6_TMP="/var/opt/snapshots/liquidwar6/tmp"
LW6_BRANCH="liquidwar6--beta"
LW6_VERSION=`date +%Y%m%d`"snapshot"
LW6_LOG_FILE=$LW6_LOG/liquidwar6-${LW6_VERSION}

install -d $LW6_LOG && cd $LW6_LOG || exit 1
install -d $LW6_PUB || exit 1
install -d $LW6_TMP || exit 1
find $LW6_TMP -type f -exec chmod a+rw "{}" \;
find $LW6_TMP -type d -exec chmod a+rwx "{}" \;
rm -rf $LW6_TMP && mkdir $LW6_TMP && cd $LW6_TMP || exit 1
cd $LW6_TMP

tla register-archive "http://arch.savannah.gnu.org/archives/liquidwar6" > /dev/null 2>&1
tla get --archive "liquidwar6@sv.gnu.org" $LW6_BRANCH > ${LW6_LOG_FILE}.get.log.txt 2>&1

cd liquidwar6--beta* || exit 1

cp configure.ac configure.ac.orig
cat configure.ac.orig | perl -e "while (<>) { if (/^AC_INIT/) { print \"AC_INIT([Liquid War 6],[${LW6_VERSION}],[ufoot@ufoot.org],[liquidwar6])\"; } else { print \$_; } }" > configure.ac

./autoreconf > ${LW6_LOG_FILE}.autoreconf.log.txt 2>&1
./configure > ${LW6_LOG_FILE}.configure.log.txt 2>&1
make > ${LW6_LOG_FILE}.make.log.txt 2>&1
make check > ${LW6_LOG_FILE}.check.log.txt 2>&1
make dist > ${LW6_LOG_FILE}.dist.log.txt 2>&1
rm -f liquidwar6-${LW6_VERSION}.tar.gz
make distcheck > ${LW6_LOG_FILE}.distcheck.log.txt 2>&1
if test -f liquidwar6-${LW6_VERSION}.tar.gz ; then
	mv liquidwar6-${LW6_VERSION}.tar.gz $LW6_PUB
	exit 0
else
	exit 1
fi
